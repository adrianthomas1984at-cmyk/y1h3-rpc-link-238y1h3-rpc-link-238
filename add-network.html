<!doctype html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<body style="font:16px system-ui; padding:20px; max-width:720px; margin:auto;">
<h2>Add Ethereum Mainnet</h2>
<p>If you don‚Äôt see a prompt, tap <b>Connect</b> then <b>Add/Switch Network</b>. If you‚Äôre <i>not</i> inside a wallet, use one of the open-in-wallet buttons.</p>

<div style="display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 16px;">
  <button id="openMM" style="padding:12px 16px; border-radius:10px;">Open in MetaMask (mobile)</button>
  <button id="openTW" style="padding:12px 16px; border-radius:10px;">Open in Trust Wallet (mobile)</button>
  <button id="copyTW" style="padding:12px 16px; border-radius:10px;">Copy Trust deeplink</button>
  <button id="connect" style="padding:12px 16px; border-radius:10px;">Connect</button>
  <button id="add" style="padding:12px 16px; border-radius:10px;">Add/Switch Network</button>
</div>

<pre id="status" style="white-space:pre-wrap; background:#f6f6f6; padding:12px; border-radius:10px; margin-top:8px;"></pre>

<script>
  // ====== Ethereum Mainnet params ======
  const params = [{
    chainId: '0x1',
    chainName: 'Ethereum Mainnet',
    rpcUrls: ['https://rpc.ankr.com/eth'], // replace with your preferred HTTPS RPC
    nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
    blockExplorerUrls: ['https://etherscan.io']
  }];
  // =====================================

  const statusEl = document.getElementById('status');
  const log = (m) => { statusEl.textContent = m; };

  // --- Environment detection helpers ---
  const isTrustContext = () => {
    return !!(window.trustwallet?.ethereum) ||
           !!(window.ethereum && (window.ethereum.isTrust || window.ethereum.isTrustWallet));
  };
  const isMetaMaskContext = () => {
    const eth = window.ethereum;
    if (!eth) return false;
    const list = eth.providers || [eth];
    return !!list.find(p => p && p.isMetaMask);
  };

  // --- Mobile deep links (HTTPS only) ---
  const PAGE_URL = window.location.href;
  const ENC = encodeURIComponent(PAGE_URL);
  const MM_LINK = `https://link.metamask.io/dapp/${ENC}`;
  const TW_LINK = `https://link.trustwallet.com/open_url?coin_id=60&url=${ENC}`;

  document.getElementById('openMM').onclick = () => {
    // Only deep-link if we're NOT already in MetaMask‚Äôs browser
    if (isMetaMaskContext()) {
      log('Already in MetaMask browser. Use Connect ‚Üí Add/Switch.');
    } else {
      window.location.href = MM_LINK;
    }
  };

  document.getElementById('openTW').onclick = () => {
    // Only deep-link if we're NOT already in Trust‚Äôs browser
    if (isTrustContext()) {
      log('Already in Trust Wallet browser. Use Connect ‚Üí Add/Switch.');
    } else {
      // Use HTTPS link (NOT trust://). If Android‚Äôs webview blocks navigation,
      // use the Copy button and paste this link in Chrome/Safari.
      window.location.href = TW_LINK;
    }
  };

  document.getElementById('copyTW').onclick = async () => {
    try {
      await navigator.clipboard.writeText(TW_LINK);
      log('üìã Trust deeplink copied. Open it from Chrome/Safari (outside the wallet) to launch Trust Wallet.');
    } catch {
      log('Copy failed. Long-press to select & copy:\n' + TW_LINK);
    }
  };

  // --- EIP-6963 discovery (multi-wallet) ---
  let discoveredProviders = [];
  window.addEventListener('eip6963:announceProvider', (event) => {
    const provider = event.detail?.provider;
    if (provider && !discoveredProviders.includes(provider)) discoveredProviders.push(provider);
  });
  window.dispatchEvent(new Event('eip6963:requestProvider'));

  function pickProvider() {
    // 1) Trust Wallet explicit
    if (window.trustwallet && window.trustwallet.ethereum) return window.trustwallet.ethereum;

    // 2) EIP-6963 announced
    const byFlag = (p) => p && (p.isTrustWallet || p.isTrust || p.isMetaMask);
    if (discoveredProviders.length) {
      return discoveredProviders.find(p => p.isTrustWallet || p.isTrust)
          || discoveredProviders.find(p => p.isMetaMask)
          || discoveredProviders[0];
    }

    // 3) Classic window.ethereum (+ multi-provider)
    const eth = window.ethereum;
    if (!eth) return null;
    const list = eth.providers || [eth];
    return list.find(p => p && (p.isTrustWallet || p.isTrust))
        || list.find(p => p && p.isMetaMask)
        || list[0];
  }

  async function connect(provider) {
    try {
      await provider.request({ method: 'eth_requestAccounts' });
      log('‚úÖ Connected to wallet.');
    } catch (e1) {
      // Legacy enable fallback
      if (typeof provider.enable === 'function') {
        try {
          await provider.enable();
          log('‚úÖ Connected (legacy enable).');
        } catch (e2) {
          log('‚ö†Ô∏è Connect failed: ' + (e2?.message || e2));
          throw e2;
        }
      } else {
        log('‚ö†Ô∏è Connect failed: ' + (e1?.message || e1));
        throw e1;
      }
    }
  }

  async function addAndSwitch(provider) {
    try {
      await provider.request({ method: 'wallet_addEthereumChain', params });
    } catch (e) {
      const msg = String(e?.message || e);
      if (!/already|exist/i.test(msg)) throw e; // only ignore "already added"
    }
    await provider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: params[0].chainId }] });
    log('‚úÖ Ethereum Mainnet added & switched.');
  }

  document.getElementById('connect').onclick = async () => {
    const provider = pickProvider();
    if (!provider) return log('No wallet detected. If on mobile, use a button above to open this page inside your wallet.');
    await connect(provider);
  };

  document.getElementById('add').onclick = async () => {
    const provider = pickProvider();
    if (!provider) return log('No wallet detected. If on mobile, use a button above to open this page inside your wallet.');
    try {
      await connect(provider).catch(()=>{});
      await addAndSwitch(provider);
    } catch (e) {
      log('‚ö†Ô∏è ' + (e?.message || e));
    }
  };

  // --- Wait for wallet init events, then auto-attempt with retries ---
  function onReadyToDetect(){ attemptAuto(); }
  window.addEventListener('ethereum#initialized', onReadyToDetect, { once:true });
  window.addEventListener('trustwallet#initialized', onReadyToDetect, { once:true });

  async function attemptAuto() {
    log('Looking for a wallet provider‚Ä¶');
    const start = Date.now(), timeoutMs = 6000;
    while (Date.now() - start < timeoutMs) {
      const p = pickProvider();
      if (p) {
        log('Wallet detected. Attempting add/switch‚Ä¶');
        try {
          await connect(p).catch(()=>{});
          await addAndSwitch(p);
        } catch (e) {
          log('‚ö†Ô∏è ' + (e?.message || e));
        }
        return;
      }
      await new Promise(r => setTimeout(r, 250));
    }
    log('No wallet detected. If you‚Äôre in Chrome/Safari, use the buttons to open this page inside MetaMask/Trust. If you‚Äôre already in Trust, tap Connect ‚Üí Add/Switch.');
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attemptAuto);
  } else {
    attemptAuto();
  }
</script>
</body>
</html>
