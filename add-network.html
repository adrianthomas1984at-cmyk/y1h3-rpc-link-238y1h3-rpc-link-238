<!doctype html>
<html>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<body style="font:16px system-ui; padding:20px; max-width:720px; margin:auto;">
<h2>Add Ethereum Mainnet</h2>
<p>If you don’t see a prompt, tap a wallet button or press Connect.</p>

<div style="display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 16px;">
  <button id="mm" style="padding:12px 16px; border-radius:10px;">Open in MetaMask (mobile)</button>
  <button id="tw" style="padding:12px 16px; border-radius:10px;">Open in Trust Wallet (mobile)</button>
  <button id="connect" style="padding:12px 16px; border-radius:10px;">Connect</button>
  <button id="add" style="padding:12px 16px; border-radius:10px;">Add/Switch Network</button>
</div>

<pre id="status" style="white-space:pre-wrap; background:#f6f6f6; padding:12px; border-radius:10px; margin-top:8px;"></pre>

<script>
  // ====== Ethereum Mainnet params ======
  const params = [{
    chainId: '0x1',
    chainName: 'Ethereum Mainnet',
    rpcUrls: ['https://rpc.ankr.com/eth'], // replace with your preferred HTTPS RPC
    nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
    blockExplorerUrls: ['https://etherscan.io']
  }];
  // =====================================

  const statusEl = document.getElementById('status');
  const log = (m) => { statusEl.textContent = m; };

  // --- Deep links for mobile ---
  const dappUrl = encodeURIComponent(window.location.href);
  document.getElementById('mm').onclick = () => {
    window.location.href = `https://link.metamask.io/dapp/${dappUrl}`;
  };
  document.getElementById('tw').onclick = () => {
    window.location.href = `https://link.trustwallet.com/open_url?coin_id=60&url=${dappUrl}`;
  };

  // --- EIP-6963 provider discovery (multi-wallet) ---
  let discoveredProviders = [];
  window.addEventListener('eip6963:announceProvider', (event) => {
    const provider = event.detail?.provider;
    if (provider && !discoveredProviders.includes(provider)) discoveredProviders.push(provider);
  });
  window.dispatchEvent(new Event('eip6963:requestProvider'));

  // --- Helper: pick best provider (Trust first) ---
  function pickProvider() {
    // 1) Trust Wallet explicit injection point (mobile)
    if (window.trustwallet && window.trustwallet.ethereum) return window.trustwallet.ethereum;

    // 2) EIP-6963 announced providers
    const byFlag = (p) => p && (p.isTrustWallet || p.isTrust || p.isMetaMask);
    if (discoveredProviders.length) {
      return discoveredProviders.find(p => p.isTrustWallet || p.isTrust)
          || discoveredProviders.find(p => p.isMetaMask)
          || discoveredProviders[0];
    }

    // 3) Classic window.ethereum (+ multi-provider)
    const eth = window.ethereum;
    if (!eth) return null;
    const list = eth.providers || [eth];
    return list.find(p => p && (p.isTrustWallet || p.isTrust))
        || list.find(p => p && p.isMetaMask)
        || list[0];
  }

  async function connect(provider) {
    try {
      // Try the modern request flow
      await provider.request({ method: 'eth_requestAccounts' });
      log('✅ Connected to wallet.');
    } catch (e1) {
      // Legacy fallback (some old Trust builds)
      try {
        if (typeof provider.enable === 'function') {
          await provider.enable();
          log('✅ Connected (legacy enable).');
        } else {
          throw e1;
        }
      } catch (e2) {
        log('⚠️ Connect failed: ' + (e2?.message || e2));
        throw e2;
      }
    }
  }

  async function addAndSwitch(provider) {
    try {
      await provider.request({ method: 'wallet_addEthereumChain', params });
    } catch (e) {
      // Already added? proceed to switch
      const msg = String(e?.message || e);
      if (!/already|exist/i.test(msg)) throw e;
    }
    await provider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: params[0].chainId }] });
    log('✅ Ethereum Mainnet added & switched.');
  }

  document.getElementById('connect').onclick = async () => {
    const provider = pickProvider();
    if (!provider) return log('No wallet detected. Use the MetaMask/Trust buttons above.');
    await connect(provider);
  };

  document.getElementById('add').onclick = async () => {
    const provider = pickProvider();
    if (!provider) return log('No wallet detected. Use the MetaMask/Trust buttons above.');
    try {
      await connect(provider).catch(()=>{});
      await addAndSwitch(provider);
    } catch (e) {
      log('⚠️ ' + (e?.message || e));
    }
  };

  // --- Wait for wallet initialization events (Trust/MM) ---
  function onReadyToDetect() {
    attemptAuto();
  }
  window.addEventListener('ethereum#initialized', onReadyToDetect, { once: true });
  window.addEventListener('trustwallet#initialized', onReadyToDetect, { once: true });

  // --- Auto attempt with retries (handles slow injection) ---
  async function attemptAuto() {
    log('Looking for a wallet provider…');
    const start = Date.now();
    const timeoutMs = 5000;
    while (Date.now() - start < timeoutMs) {
      const p = pickProvider();
      if (p) {
        log('Wallet detected. Attempting add/switch…');
        try {
          await connect(p).catch(()=>{});
          await addAndSwitch(p);
        } catch (e) {
          log('⚠️ ' + (e?.message || e));
        }
        return;
      }
      await new Promise(r => setTimeout(r, 200));
    }
    log('No wallet detected. Use the MetaMask/Trust buttons above to open this page inside your wallet, then tap Connect.');
  }

  // Kick off once DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attemptAuto);
  } else {
    attemptAuto();
  }
</script>
</body>
</html>
